# Non-Fungible Career

## 東京大学 ブロックチェーンイノベーション寄附講座

### MOF グループリポジトリ

---

## 📋 目次

1. [環境設定](#環境設定)
2. [進捗・ステータス](#進捗ステータス)
3. [設計概要](#設計概要)
4. [アプリケーション概要](#アプリケーション概要)
5. [データベース設計](#データベース設計)
6. [詳細仕様手順](#詳細仕様手順)

---

## 環境設定

### 前提条件

以下のソフトウェアがインストールされていることを確認してください：

- **Node.js 18 以上** - [公式サイト](https://nodejs.org/)からインストール
- **npm** - Node.js に含まれています
- **Docker Desktop** - [公式サイト](https://www.docker.com/products/docker-desktop/)からインストール
- **Git** - [公式サイト](https://git-scm.com/)からインストール
- **MetaMask** - [ブラウザ拡張機能](https://metamask.io/)をインストール

**確認コマンド**:

```bash
node --version  # v18以上であることを確認
npm --version
docker --version
docker compose version
git --version
```

### 完全セットアップ手順（初見でも実行可能）

この手順に従うことで、Git プル後からアプリが正常に動作するまでを一通り実行できます。

#### ステップ 1: リポジトリのクローン

```bash
git clone <repository-url>
cd career-passport
```

#### ステップ 2: Foundry のインストール

```bash
# Foundry のインストールスクリプトをダウンロードして実行
curl -L https://foundry.paradigm.xyz | bash

# foundryup を実行（初回のみ）
foundryup
```

インストール後、ターミナルを再起動するか、以下のコマンドでパスを更新します：

```bash
source ~/.bashrc  # または source ~/.zshrc
```

**確認**:

```bash
forge --version
cast --version
anvil --version
```

#### ステップ 3: コントラクトのセットアップ

```bash
# contracts ディレクトリに移動
cd contracts

# OpenZeppelin Contracts のインストール
forge install OpenZeppelin/openzeppelin-contracts

# コントラクトのコンパイル
forge build
```

#### ステップ 4: バックエンドのセットアップ

**ターミナル 1**: 新しいターミナルを開いて実行

```bash
cd backend

# 依存関係のインストール
npm install

# 環境変数ファイルの作成（.envファイルが存在しない場合）
# 以下の内容で backend/.env を作成してください：
cat > .env << 'EOF'
# DynamoDB 設定（Docker で起動した DynamoDB Local を使用）
AWS_REGION=ap-northeast-1
DYNAMODB_ENDPOINT=http://localhost:8000

# DynamoDB テーブル名
DYNAMODB_TABLE_EVENT_APPLICATIONS=NonFungibleCareerEventApplications
DYNAMODB_TABLE_MESSAGES=NonFungibleCareerMessages
DYNAMODB_TABLE_MATCHES=NonFungibleCareerMatches

# JWT 設定
JWT_SECRET=your-secret-key-change-in-production

# サーバー設定
PORT=3000
EOF

# DynamoDB Local (Docker) を起動
npm run dynamodb:up

# 数秒待ってから、DynamoDB テーブルを作成
sleep 3
npm run create-api-tables

# バックエンドAPIサーバーを起動
npm run dev
```

**確認**: ターミナルに `Backend running on 3000` と表示されれば成功です。

#### ステップ 5: ローカルブロックチェーン（Anvil）の起動とコントラクトのデプロイ

**ターミナル 2**: 新しいターミナルを開いて実行

```bash
cd contracts

# Anvil を起動（このターミナルは起動したままにしておく）
anvil
```

**ターミナル 3**: 新しいターミナルを開いて実行

```bash
cd contracts

# コントラクトをデプロイ
bash scripts/deploy-all.sh
```

このスクリプトは以下を実行します：

1. `NonFungibleCareerNFT`をデプロイ
2. `StampManager`をデプロイ
3. デプロイ済みアドレスを`deployed.json`に自動保存
4. 環境変数ファイル（`frontend/.env.local`）を自動生成

**確認**: `frontend/.env.local` ファイルが作成されていることを確認してください。

#### ステップ 6: MetaMask の設定

1. MetaMask をインストール（まだの場合）
2. ローカルネットワーク（Anvil）を追加：
   - ネットワーク名: `Anvil Local`
   - RPC URL: `http://localhost:8545`
   - Chain ID: `31337`
   - 通貨記号: `ETH`
3. （オプション）Anvil のテストアカウントをインポート
   - Anvil 起動時に表示されるプライベートキーを使用

#### ステップ 7: フロントエンドのセットアップ

**ターミナル 4**: 新しいターミナルを開いて実行

```bash
cd frontend

# 依存関係のインストール
npm install

# フロントエンドを起動
npm run dev
```

**確認**: ターミナルに `Local: http://localhost:5173` と表示されれば成功です。

#### ステップ 8: 動作確認

1. ブラウザで `http://localhost:5173` を開く
2. MetaMask でウォレットを接続
3. 以下の機能をテスト：
   - ホーム画面の表示
   - スタンプ一覧の表示
   - NFT 一覧の表示
   - イベント応募機能
   - メッセージ機能

### 起動確認チェックリスト

すべてのサービスが正常に起動しているか確認してください：

- ✅ **DynamoDB Local**: `docker ps` で `dynamodb-local` コンテナが起動中
- ✅ **バックエンド API**: `http://localhost:3000` にアクセス可能（またはターミナルに `Backend running on 3000` と表示）
- ✅ **Anvil**: ターミナルに `Listening on 127.0.0.1:8545` と表示
- ✅ **フロントエンド**: `http://localhost:5173` にアクセス可能

### トラブルシューティング

**Foundry がインストールされない場合**:

```bash
foundryup
```

**コントラクトのコンパイルエラー**:

```bash
cd contracts
forge install OpenZeppelin/openzeppelin-contracts --force
forge build
```

**Anvil に接続できない場合**:

```bash
# Anvilが起動しているか確認
curl http://localhost:8545
```

**DynamoDB Local が起動しない場合**:

```bash
cd backend
# Dockerが起動しているか確認
docker ps

# DynamoDB Localを再起動
npm run dynamodb:down
npm run dynamodb:up

# ログを確認
npm run dynamodb:logs
```

**バックエンド API に接続できない場合**:

```bash
cd backend
# テーブルが作成されているか確認
npm run create-api-tables

# サーバーを再起動
npm run dev
```

**フロントエンドが起動しない場合**:

```bash
cd frontend
# 依存関係を再インストール
rm -rf node_modules package-lock.json
npm install

# 環境変数ファイルを確認
cat .env.local
```

詳細は [Day 4 テストとデプロイガイド](./DAY4_TEST_AND_DEPLOY_GUIDE.md) と [Day 7-8 バックエンド API 実装ガイド](./DAY7-8_BACKEND_API_GUIDE.md) の「トラブルシューティング」セクションを参照してください。

---

## 進捗・ステータス

### 全体スケジュール

```
Day 1-2:  UI実装（モックデータ）          ✅ 完了
Day 3-4:  スマートコントラクト実装         ✅ 完了
Day 5:    MetaMask 連携                   ✅ 完了
Day 6:    UI とブロックチェーンの統合      ✅ 完了
Day 7-8:  バックエンド API 実装           ✅ 完了
Day 9-10: テストとアプリ完成度向上        🔧 進行中
```

### 実装完了率

- **フロントエンド UI**: 100% ✅
- **スマートコントラクト**: 100% ✅
- **ブロックチェーン連携**: 100% ✅
- **ウォレット連携**: 100% ✅
- **バックエンド API**: 100% ✅
  - イベント応募 API ✅
  - メッセージ API ✅
  - マッチング API ✅
  - DynamoDB 統合 ✅
- **ZKP 実装**: 10% ⏳（モックのみ）
- **VC 取得 API**: 0% ⏳（モックのみ）
- **テスト**: 20% ⏳（一部実装済み）
- **バグ修正**: 進行中 🔧

**全体進捗**: 約 80% 完了（機能実装は完了、テストとバグ修正が残り）

### 完了した機能

#### Day 1-2: UI 実装 ✅

- ✅ 全ページの UI 実装完了（個人ユーザー向け 11 ページ、企業ユーザー向け 11 ページ）
- ✅ WalletConnect 統合（MetaMask 認証）
- ✅ ローカルストレージでのデータ管理

#### Day 3-4: スマートコントラクト実装 ✅

- ✅ `NonFungibleCareerNFT.sol` - NFT 証明書発行コントラクト
- ✅ `StampManager.sol` - スタンプ管理コントラクト
- ✅ ユニットテスト実装完了
- ✅ ローカルネットワークへのデプロイ完了
- ✅ デプロイスクリプトとテストスクリプトの作成

#### Day 5: MetaMask 連携 ✅

- ✅ ウォレット接続機能
- ✅ ネットワーク設定
- ✅ スタンプ発行機能（ブロックチェーン経由）
- ✅ NFT 発行機能（ブロックチェーン経由）
- ✅ エラーハンドリングとトランザクション状態管理

#### Day 6: UI とブロックチェーンの統合 ✅

- ✅ 全ページのブロックチェーン連携
  - `Home.jsx` - ユーザーダッシュボード
  - `MyNFTs.jsx` - NFT 一覧
  - `OrgDashboard.jsx` - 企業ダッシュボード
  - `NFTDetail.jsx` - NFT 詳細
- ✅ ローカルストレージとブロックチェーンの同期
- ✅ エラーハンドリングの強化
- ✅ ローディング状態の表示改善
- ✅ トランザクション状態の可視化

#### Day 7-8: バックエンド API 実装 ✅

- ✅ DynamoDB Local (Docker) セットアップ
- ✅ データベーステーブル設計と作成
  - イベント応募テーブル (`NonFungibleCareerEventApplications`)
  - メッセージテーブル (`NonFungibleCareerMessages`)
  - マッチングテーブル (`NonFungibleCareerMatches`)
- ✅ イベント応募 API 実装
  - 応募作成、一覧取得、ステータス更新
- ✅ メッセージ API 実装
  - メッセージ送信、会話一覧取得、既読管理
- ✅ マッチング API 実装
  - マッチング作成、一覧取得、ステータス更新
- ✅ フロントエンド統合
  - `StudentEventApply.jsx` - イベント応募機能
  - `StudentMessages.jsx` - メッセージ機能
  - `StudentMatchedCompanies.jsx` - マッチング機能
- ✅ エラーハンドリングとデバッグログの追加

### 今後の予定

#### Day 9-10: テストとアプリ完成度向上 📋

**目標**: アプリの動作を安定させ、バグを修正して完成度を上げる

##### テスト計画

1. **単体テスト**

   - フロントエンドコンポーネントのテスト
   - バックエンド API のテスト
   - スマートコントラクトのテスト（既存テストの拡充）

2. **統合テスト**

   - フロントエンド ↔ バックエンドの連携テスト
   - フロントエンド ↔ ブロックチェーンの連携テスト
   - エンドツーエンド（E2E）テスト

3. **機能テスト**
   - イベント応募機能の動作確認
   - メッセージ機能の動作確認
   - マッチング機能の動作確認
   - スタンプ発行・NFT 取得機能の動作確認

##### バグ修正と改善

1. **既知のバグの修正**

   - API 接続エラーの修正
   - UI 表示の不具合修正
   - データ同期の問題修正
   - エラーハンドリングの改善

2. **パフォーマンス改善**

   - ページ読み込み速度の最適化
   - API レスポンス時間の改善
   - ブロックチェーン読み込みの最適化

3. **ユーザー体験の改善**

   - ローディング状態の表示改善
   - エラーメッセージの明確化
   - 操作フローの最適化
   - レスポンシブデザインの改善

4. **コード品質の向上**
   - コードレビューとリファクタリング
   - エラーハンドリングの統一
   - ログ出力の改善
   - ドキュメントの整備

##### 完成度向上のための作業

1. **エラーハンドリングの強化**

   - ネットワークエラーの適切な処理
   - トランザクション失敗時の処理
   - バックエンドエラーの適切な表示

2. **データ整合性の確保**

   - ローカルストレージとブロックチェーンの同期確認
   - DynamoDB とブロックチェーンの整合性確認
   - データの不整合を防ぐバリデーション

3. **セキュリティの強化**

   - 入力値のバリデーション
   - XSS 対策
   - 不正なリクエストの防止

4. **ドキュメントの整備**
   - API 仕様書の作成
   - トラブルシューティングガイドの拡充
   - 開発者向けドキュメントの整備

---

## 設計概要

### プロジェクト概要

**Non-Fungible Career** は、ブロックチェーン技術を活用したキャリア証明書プラットフォームです。

**主な機能**:

- 🎫 スタンプコレクション（企業からスタンプを取得）
- 🏆 NFT 証明書の取得（スタンプ 3 つで交換可能）
- 🔐 ゼロ知識証明（プライバシーを保護しながら証明）
- 📊 企業向けダッシュボード（スタンプ発行・統計管理）

### システムアーキテクチャ

```
┌─────────────────────────────────────────┐
│         Frontend (React + Vite)         │
│                                         │
│  ┌──────────┐  ┌──────────┐          │
│  │  Student │  │Organization│         │
│  │    UI    │  │    UI     │          │
│  └──────────┘  └──────────┘          │
│         │              │                │
│         └──────┬───────┘                │
│                │                        │
│         ┌─────▼─────┐                  │
│         │  Wallet   │                  │
│         │  Connect  │                  │
│         └─────┬─────┘                  │
└───────────────┼────────────────────────┘
                │
                │ (MetaMask)
                │
┌───────────────▼────────────────────────┐
│    Local Blockchain (Anvil)            │
│                                         │
│  ┌──────────────┐  ┌──────────────┐   │
│  │  NFT Contract│  │Stamp Manager │   │
│  │  (ERC721)    │  │  Contract    │   │
│  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────┘
```

### 主要機能フロー

#### スタンプ獲得から NFT 証明書取得まで

1. ユーザーがウォレット接続でログイン
2. 企業がスタンプを発行（ブロックチェーン上に記録）
3. スタンプを 3 つ集めると NFT 証明書に交換可能
4. NFT 証明書を取得（ブロックチェーン上に記録）

#### 仕事探しからマッチングまで

1. 仕事応募条件を設定
2. 条件に合った仕事を検索
3. ZKP で条件を満たすことを証明（VC から選択的に開示）
4. メッセージ交換時に VC から必要最小限の情報のみを選択的に開示
5. マッチング成立

### 技術スタック

**フロントエンド**:

- React 19 + Vite
- Tailwind CSS
- React Router
- Ethers.js v6

**バックエンド**:

- Node.js + Express.js
- AWS SDK (DynamoDB)
- DynamoDB Local (Docker)
- JWT 認証

**ブロックチェーン**:

- Foundry
- Solidity 0.8.20
- Anvil（ローカルブロックチェーン）
- OpenZeppelin

**開発ツール**:

- MetaMask
- Git
- Docker

詳細な設計情報は [プロジェクト概要書](./PROJECT_OVERVIEW.md) を参照してください。

---

## アプリケーション概要

### アプリケーションの目的

**Non-Fungible Career** は、ブロックチェーン技術を活用したキャリア証明書プラットフォームです。学生と企業を結びつけ、透明性とプライバシーを両立した人材マッチングを実現します。

### 主要な機能

#### 1. スタンプシステム 🎫

- **スタンプ発行**: 企業が学生にスタンプを発行（ブロックチェーン上に記録）
- **スタンプコレクション**: 学生が企業からスタンプを集める
- **進捗管理**: 企業別のスタンプ数を可視化

#### 2. NFT 証明書 🏆

- **NFT 発行**: 同じ企業からスタンプを 3 つ集めると NFT 証明書を取得可能
- **証明書管理**: 取得した NFT 証明書を一覧で確認
- **詳細表示**: NFT 証明書の詳細情報（レアリティ、企業情報など）を表示

#### 3. イベント応募 📅

- **イベント一覧**: NFT 獲得イベントの一覧を表示
- **応募機能**: イベントに応募（応募動機、経験・スキルを入力）
- **応募履歴**: 自分の応募履歴を確認（ステータス、応募日時など）

#### 4. メッセージ機能 💬

- **会話管理**: 企業とのメッセージ交換
- **新規会話**: 企業のウォレットアドレスを入力して会話を開始
- **情報開示**: VC（Verifiable Credential）から必要な情報のみを選択的に開示

#### 5. マッチング機能 🤝

- **条件マッチング**: 学生と企業の条件をマッチング
- **ZKP 証明**: ゼロ知識証明で条件を満たすことを証明
- **マッチング一覧**: マッチングした企業の一覧を表示

#### 6. 企業ダッシュボード 📊

- **スタンプ発行**: 学生へのスタンプ発行機能
- **統計管理**: 発行済みスタンプ数、参加者数、NFT 発行数の表示
- **イベント管理**: イベントの作成と管理

### ユーザーフロー

#### 学生ユーザー

1. **ウォレット接続**: MetaMask でウォレットを接続
2. **イベント応募**: NFT 獲得イベントに応募
3. **スタンプ獲得**: 企業からスタンプを獲得（ブロックチェーン上に記録）
4. **NFT 取得**: スタンプを 3 つ集めて NFT 証明書を取得
5. **メッセージ交換**: 企業とメッセージで連絡
6. **マッチング**: 条件に合った企業とマッチング

#### 企業ユーザー

1. **ウォレット接続**: MetaMask でウォレットを接続
2. **スタンプ発行**: 学生にスタンプを発行（ブロックチェーン上に記録）
3. **イベント管理**: NFT 獲得イベントを作成・管理
4. **応募確認**: イベントへの応募を確認
5. **メッセージ交換**: 学生とメッセージで連絡
6. **マッチング**: 条件に合った学生とマッチング

---

## データベース設計

### 概要

本アプリケーションでは、**DynamoDB** を使用してデータを管理しています。開発環境では **DynamoDB Local (Docker)** を使用し、本番環境では **AWS DynamoDB** を使用できます。

### データストレージの構成

```
┌─────────────────────────────────────────┐
│         DynamoDB (DynamoDB Local)      │
│                                         │
│  ┌─────────────────────────────────┐  │
│  │  EventApplications テーブル      │  │
│  └─────────────────────────────────┘  │
│  ┌─────────────────────────────────┐  │
│  │  Messages テーブル              │  │
│  └─────────────────────────────────┘  │
│  ┌─────────────────────────────────┐  │
│  │  Matches テーブル               │  │
│  └─────────────────────────────────┘  │
└─────────────────────────────────────────┘
         │
         │
┌────────▼─────────────────────────────────┐
│   ブロックチェーン (Anvil)               │
│                                         │
│  ┌─────────────────────────────────┐  │
│  │  StampManager コントラクト       │  │
│  │  (スタンプデータ)                │  │
│  └─────────────────────────────────┘  │
│  ┌─────────────────────────────────┐  │
│  │  NonFungibleCareerNFT コントラクト│ │
│  │  (NFT証明書データ)              │  │
│  └─────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

**設計方針**:

- **ブロックチェーン**: スタンプと NFT 証明書のデータ（改ざん不可能な重要なデータ）
- **DynamoDB**: イベント応募、メッセージ、マッチングのデータ（頻繁に更新されるデータ）

### テーブル設計

#### 1. イベント応募テーブル (`NonFungibleCareerEventApplications`)

イベントへの応募情報を管理します。

**プライマリキー**:

- `applicationId` (String) - 応募 ID（UUID）

**グローバルセカンダリインデックス (GSI)**:

- `EventIndex` - `eventId` で検索（イベント別の応募一覧取得）
- `WalletIndex` - `walletAddress` で検索（ユーザー別の応募一覧取得）

**主要フィールド**:

- `applicationId` (String) - 応募 ID
- `eventId` (String) - イベント ID
- `walletAddress` (String) - 応募者のウォレットアドレス
- `applicationText` (String) - 応募動機・経験・スキル
- `appliedAt` (String) - 応募日時（ISO 8601 形式）
- `status` (String) - ステータス（`pending`, `approved`, `rejected`）

**使用例**:

- イベントへの応募作成
- イベント別の応募一覧取得
- ユーザー別の応募履歴取得
- 応募ステータスの更新

#### 2. メッセージテーブル (`NonFungibleCareerMessages`)

学生と企業間のメッセージを管理します。

**プライマリキー**:

- `messageId` (String) - メッセージ ID（UUID）

**グローバルセカンダリインデックス (GSI)**:

- `ConversationIndex` - `conversationId` で検索（会話別のメッセージ一覧取得）
- `SenderIndex` - `senderAddress` で検索（送信者別のメッセージ一覧取得）

**主要フィールド**:

- `messageId` (String) - メッセージ ID
- `conversationId` (String) - 会話 ID（送信者と受信者のアドレスをソートして結合）
- `senderAddress` (String) - 送信者のウォレットアドレス
- `receiverAddress` (String) - 受信者のウォレットアドレス
- `content` (String) - メッセージ内容
- `sentAt` (String) - 送信日時（ISO 8601 形式）
- `read` (Boolean) - 既読フラグ

**会話 ID の生成ロジック**:

```javascript
// 送信者と受信者のアドレスを小文字に変換してソートし、アンダースコアで結合
conversationId = `${address1.toLowerCase()}_${address2.toLowerCase()}`;
// 例: "0x1111..._0x2222..."
```

**使用例**:

- メッセージの送信
- 会話別のメッセージ一覧取得
- 会話一覧の取得（最新メッセージ、未読数など）
- メッセージの既読管理

#### 3. マッチングテーブル (`NonFungibleCareerMatches`)

学生と企業のマッチング情報を管理します。

**プライマリキー**:

- `matchId` (String) - マッチング ID（UUID）

**グローバルセカンダリインデックス (GSI)**:

- `StudentIndex` - `studentAddress` で検索（学生別のマッチング一覧取得）
- `OrgIndex` - `orgAddress` で検索（企業別のマッチング一覧取得）

**主要フィールド**:

- `matchId` (String) - マッチング ID
- `studentAddress` (String) - 学生のウォレットアドレス
- `orgAddress` (String) - 企業のウォレットアドレス
- `zkpProofHash` (String, nullable) - ZKP 証明のハッシュ（オプション）
- `matchedAt` (String) - マッチング日時（ISO 8601 形式）
- `status` (String) - ステータス（`active`, `closed`）

**使用例**:

- マッチングの作成
- 学生別のマッチング一覧取得
- 企業別のマッチング一覧取得
- マッチングステータスの更新

### データ設計の特徴

#### Web3 設計原則

1. **プライバシー保護**: 個人情報（名前、メールアドレスなど）は保存せず、ウォレットアドレスのみを使用
2. **非中央集権**: 重要なデータ（スタンプ、NFT）はブロックチェーン上で管理
3. **透明性**: すべてのトランザクションがブロックチェーン上で記録され、検証可能

#### データの分離

- **ブロックチェーン**: 改ざん不可能な重要なデータ（スタンプ、NFT 証明書）
- **DynamoDB**: 頻繁に更新されるデータ（応募、メッセージ、マッチング）

#### インデックス設計

各テーブルには、よく使用されるクエリパターンに合わせて GSI（グローバルセカンダリインデックス）を設定しています：

- **イベント応募**: イベント別、ユーザー別の検索
- **メッセージ**: 会話別、送信者別の検索
- **マッチング**: 学生別、企業別の検索

### テーブル作成方法

```bash
cd backend
npm run create-api-tables
```

このコマンドで、上記の 3 つのテーブルが作成されます。

詳細は [Day 7-8 バックエンド API 実装ガイド](./DAY7-8_BACKEND_API_GUIDE.md) を参照してください。

---

## 詳細仕様手順

### 📖 主要ドキュメント

- **[プロジェクト概要書](./PROJECT_OVERVIEW.md)**: プロジェクト全体の概要、アーキテクチャ、設計

### 📋 詳細手順書（Day 別）

- **[Day 3 セットアップガイド](./DAY3_FOUNDRY_SETUP_GUIDE.md)**: Foundry セットアップとコントラクト実装
- **[Day 4 テストとデプロイガイド](./DAY4_TEST_AND_DEPLOY_GUIDE.md)**: テストとデプロイ手順
- **[Day 5 MetaMask 連携ガイド](./DAY5_WALLET_INTEGRATION_GUIDE.md)**: ウォレット連携実装
- **[Day 6 ブロックチェーン統合ガイド](./DAY6_BLOCKCHAIN_INTEGRATION_GUIDE.md)**: UI とブロックチェーンの統合
- **[Day 7-8 バックエンド API 実装ガイド](./DAY7-8_BACKEND_API_GUIDE.md)**: バックエンド API の実装とフロントエンド統合
- **[テストガイド](./backend/TEST_GUIDE.md)**: API 動作確認とテスト手順

---

**最終更新**: 2025 年 12 月 11 日（Day 8 完了）
